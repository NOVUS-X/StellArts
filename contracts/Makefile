.PHONY: build test clean deploy install help

# Default target
.DEFAULT_GOAL := help

# Contract names
CONTRACTS = escrow reputation

help: ## Show this help message
	@echo "StellArts Smart Contracts - Make Commands"
	@echo ""
	@echo "Usage: make [target]"
	@echo ""
	@echo "Targets:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  %-15s %s\n", $$1, $$2}'

install: ## Install required tools and dependencies
	@echo "Installing Rust toolchain..."
	@rustup target add wasm32-unknown-unknown
	@echo "Installing Stellar CLI..."
	@cargo install --locked stellar-cli --features opt
	@echo "âœ… Installation complete!"

build: ## Build all contracts
	@echo "ğŸ”¨ Building all contracts..."
	@cargo build --release --target wasm32-unknown-unknown
	@echo "âœ… Build complete!"
	@echo ""
	@echo "Contracts built:"
	@ls -lh target/wasm32-unknown-unknown/release/*.wasm | awk '{print "  - " $$9 ": " $$5}'

build-escrow: ## Build escrow contract only
	@echo "ğŸ”¨ Building escrow contract..."
	@cd escrow && cargo build --release --target wasm32-unknown-unknown
	@echo "âœ… Escrow contract built!"

build-reputation: ## Build reputation contract only
	@echo "ğŸ”¨ Building reputation contract..."
	@cd reputation && cargo build --release --target wasm32-unknown-unknown
	@echo "âœ… Reputation contract built!"

test: ## Run all tests
	@echo "ğŸ§ª Running tests..."
	@cargo test
	@echo "âœ… All tests passed!"

test-escrow: ## Run escrow contract tests
	@echo "ğŸ§ª Testing escrow contract..."
	@cd escrow && cargo test

test-reputation: ## Run reputation contract tests
	@echo "ğŸ§ª Testing reputation contract..."
	@cd reputation && cargo test

test-coverage: ## Run tests with coverage
	@echo "ğŸ§ª Running tests with coverage..."
	@cargo tarpaulin --out Html --output-dir ./coverage
	@echo "âœ… Coverage report: ./coverage/index.html"

clean: ## Clean build artifacts
	@echo "ğŸ§¹ Cleaning build artifacts..."
	@cargo clean
	@echo "âœ… Clean complete!"

fmt: ## Format code
	@echo "ğŸ“ Formatting code..."
	@cargo fmt --all
	@echo "âœ… Format complete!"

lint: ## Run clippy linter
	@echo "ğŸ” Running clippy..."
	@cargo clippy --all-targets --all-features -- -D warnings
	@echo "âœ… Lint complete!"

check: ## Check code without building
	@echo "ğŸ” Checking code..."
	@cargo check --target wasm32-unknown-unknown
	@echo "âœ… Check complete!"

optimize: build ## Optimize wasm files
	@echo "âš¡ Optimizing contracts..."
	@stellar contract optimize --wasm target/wasm32-unknown-unknown/release/escrow.wasm
	@stellar contract optimize --wasm target/wasm32-unknown-unknown/release/reputation.wasm
	@echo "âœ… Optimization complete!"

deploy-testnet: build ## Deploy contracts to testnet
	@echo "ğŸš€ Deploying to testnet..."
	@bash deploy.sh testnet

deploy-mainnet: build ## Deploy contracts to mainnet
	@echo "ğŸš€ Deploying to mainnet..."
	@bash deploy.sh mainnet

watch: ## Watch for changes and rebuild
	@echo "ğŸ‘€ Watching for changes..."
	@cargo watch -x 'build --release --target wasm32-unknown-unknown'

doc: ## Generate documentation
	@echo "ğŸ“š Generating documentation..."
	@cargo doc --no-deps --open
	@echo "âœ… Documentation generated!"

all: clean build test ## Clean, build, and test
	@echo "âœ… All tasks complete!"
